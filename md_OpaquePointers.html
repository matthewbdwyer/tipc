<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>tipc: Quick summary of Opaque Pointers and how that affects TIPC.</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">tipc
   </div>
   <div id="projectbrief">A TIP to LLVM compiler</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Quick summary of Opaque Pointers and how that affects TIPC.</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md43"></a> LLVM IR traditionally used pointers with explicit pointee types (e.g., <code>i32*</code>). LLVM's opaque pointer project aims to simplify this by replacing pointers with a generic opaque type (<code>ptr</code>). This change is driven by the need to address issues related to the complexity and limitations of explicit pointee types in LLVM's optimization processes and the challenges they pose to frontends and LLVM passes.</p>
<h2><a class="anchor" id="autotoc_md44"></a>
Changes in LLVM15+:</h2>
<ul>
<li><b>Opaque Pointer Type</b>:<ul>
<li>Replaces explicit pointee types (e.g., <code>i32*</code>) with a generic <code>ptr</code> type.</li>
<li>Instructions now include type arguments directly (e.g., <code>load i64, ptr p</code> instead of <code>load i64* p</code>).</li>
</ul>
</li>
<li><b>Address Spaces</b>:<ul>
<li>Address spaces remain unchanged and are used as before for differentiating pointer types relevant to architecture-specific lowering.</li>
</ul>
</li>
<li><b>Migration Instructions</b>:<ul>
<li><b>Removal of Functions</b>: Functions like <code>PointerType::getElementType()</code> and <code>Type::getPointerElementType()</code> are deprecated.</li>
</ul>
</li>
<li><b>Frontends Adjustments</b>:<ul>
<li>Frontends need to independently manage pointee types. Certain C API functions related to pointer types are deprecated or replaced.</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md45"></a>
Changes in TIPC</h1>
<blockquote class="doxtable">
<p>&zwj;[Old Code: <a href="https://github.com/matthewbdwyer/tipc/blob/0836f7a3999c9a6e4a8093ded668c3d6c2fbee16/src/codegen/CodeGenFunctions.cpp">commit 0836f7a</a>] - [New Code: <a href="https://github.com/matthewbdwyer/tipc/blob/68526bfa1746b58884e50c47c6812184c8201212/src/codegen/CodeGenFunctions.cpp">commit 540f37f</a>] </p>
</blockquote>
<p>The significant changes are in the way we handle types and function table in <a href="../src/codegen/CodeGenFunctions.cpp">CodeGenFunctions.cpp</a>.</p>
<h3><a class="anchor" id="autotoc_md46"></a>
Major Changes</h3>
<ul>
<li><b>Function table structure:</b><ul>
<li>From array of "Function type pointer", for example - <code>i64()*</code>, to <code>ptr</code> pointer type. As an upside, the new function table looks cleaner.</li>
</ul>
</li>
</ul>
<p>Following is the function table of <code>test/system/iotests/fib.tip</code>, pre- and post-change -</p>
<div class="fragment"><div class="line">@_tip_ftable = internal constant [2 x i64 ()*] [i64 ()* bitcast (i64 (i64)* @fib to i64 ()*), i64 ()* @_tip_main]</div>
</div><!-- fragment --><p>to</p>
<div class="fragment"><div class="line">@_tip_ftable = internal constant [2 x ptr] [ptr @fib, ptr @_tip_main]</div>
</div><!-- fragment --><ul>
<li><b>Function pointer changed from typed to opaque:</b></li>
</ul>
<div class="fragment"><div class="line"> ++</div>
<div class="line"><span class="keyword">auto</span> *genFunPtrType = PointerType::get(FunctionType::get(Type::getInt64Ty(TheContext), None, <span class="keyword">false</span>), 0);</div>
</div><!-- fragment --><p>to</p>
<div class="fragment"><div class="line"> ++</div>
<div class="line"><span class="keyword">auto</span> *FunctionOpaquePtrType = llvm::PointerType::get(llvmContext, 0);</div>
</div><!-- fragment --><ul>
<li><b>Load types adjustments to account for <code>ptr -&gt; &lt;target_type&gt;</code>:</b></li>
</ul>
<div class="fragment"><div class="line"> ++</div>
<div class="line"><span class="keyword">auto</span> *inVal = Builder.CreateLoad(gep-&gt;getType()-&gt;getPointerElementType(), gep, <span class="stringliteral">&quot;tipinput&quot;</span> + std::to_string(argIdx++));</div>
</div><!-- fragment --><div class="fragment"><div class="line"> ++</div>
<div class="line"><span class="keyword">auto</span> *inVal = irBuilder.CreateLoad(llvm::Type::getInt64Ty(llvmContext), gep, <span class="stringliteral">&quot;tipinput&quot;</span> + std::to_string(argIdx++));</div>
</div><!-- fragment --><ul>
<li><b>Function call resolutions:</b></li>
</ul>
<div class="fragment"><div class="line"> ++</div>
<div class="line"><span class="keyword">auto</span> *gep = Builder.CreateInBoundsGEP(tipFTable-&gt;getValueType(), tipFTable, indices, <span class="stringliteral">&quot;ftableidx&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Load the function pointer</span></div>
<div class="line"><span class="keyword">auto</span> *genericFunPtr = Builder.CreateLoad(gep-&gt;getType()-&gt;getPointerElementType(), gep, <span class="stringliteral">&quot;genfptr&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Compute the specific function pointer type based on the actual parameter list.</span></div>
<div class="line">...</div>
<div class="line">auto *funType = FunctionType::get(Type::getInt64Ty(TheContext), actualTypes, <span class="keyword">false</span>);</div>
<div class="line"><span class="keyword">auto</span> *funPtrType = PointerType::get(funType, 0);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Bitcast the function pointer to the call-site determined function type</span></div>
<div class="line"><span class="keyword">auto</span> *castFunPtr = Builder.CreatePointerCast(genericFunPtr, funPtrType, <span class="stringliteral">&quot;castfptr&quot;</span>);</div>
<div class="line"> </div>
<div class="line">...</div>
<div class="line"> </div>
<div class="line">return Builder.CreateCall(funType, castFunPtr, argsV, <span class="stringliteral">&quot;calltmp&quot;</span>);</div>
</div><!-- fragment --><p>Is now simpler with fewer operations, because we are not using typed pointers anymore, we don't need <code>PointerCast</code> or <code>BitCast</code> -</p>
<div class="fragment"><div class="line"> ++</div>
<div class="line"><span class="keyword">auto</span> *gep = irBuilder.CreateInBoundsGEP(tipFunctionTable-&gt;getValueType(), tipFunctionTable, indices, <span class="stringliteral">&quot;ftableidx&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Load the function pointer</span></div>
<div class="line"><span class="keyword">auto</span> *functionPointer = irBuilder.CreateLoad(llvm::PointerType::get(llvmContext, 0), gep, <span class="stringliteral">&quot;genfptr&quot;</span>);</div>
<div class="line">...</div>
<div class="line"> </div>
<div class="line">auto *funType = llvm::FunctionType::get(llvm::Type::getInt64Ty(llvmContext), actualTypes, <span class="keyword">false</span>);</div>
<div class="line">...</div>
<div class="line"> </div>
<div class="line">return irBuilder.CreateCall(funType, functionPointer, argsV, <span class="stringliteral">&quot;calltmp&quot;</span>);</div>
</div><!-- fragment --><ul>
<li><b>Using new inserters instead of vector push_backs:</b></li>
</ul>
<div class="fragment"><div class="line"> ++</div>
<div class="line">TheFunction-&gt;getBasicBlockList().push_back(ExitBB);</div>
</div><!-- fragment --><div class="fragment"><div class="line"> ++</div>
<div class="line">TheFunction-&gt;insert(TheFunction-&gt;end(), BodyBB);</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md47"></a>
Other minor changes in the code -</h3>
<ul>
<li>Renamed variables so that they have more descriptive names.</li>
<li>std::vector.reserve() calls before vector allocation loops to improve performance.</li>
<li>making reference only variables <code>const&amp;</code>, so that <code>*getFunction(std::string functionName)</code> is now <code>*getFunction(const std::string&amp; functionName)</code>. This avoids unnecessary copies. </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
